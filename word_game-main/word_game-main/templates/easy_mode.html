<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡å–®æ¨¡å¼ï¼šå–®å­—è§£è¬</title>
    <link rel="stylesheet" href="/static/easy_mode.css">
</head>
<body>
    <audio id="easy-bgm" src="/static/music_easy.mp3" loop autoplay></audio>


    <div class="bg-layer"></div>
    <a href="/" alt="go-back">
        <button id="back-btn" class="back-btn">å›ä¸Šé </button>
    </a>


    <div id="level-indicator">
        <div class="level-circle active">1</div>
        <div class="level-circle">2</div>
        <div class="level-circle">3</div>
        <div class="level-circle">4</div>
        <div class="level-circle">5</div>
        <div class="level-circle">6</div>
        <div class="level-circle">7</div>
        <div class="level-circle">8</div>
        <div class="level-circle">9</div>
        <div class="level-circle">10</div>
        <div class="level-circle">11</div>
        <div class="level-circle">12</div>
    </div>


    <div id="stars-container">
        <span class="star word-star" id="star1"></span>
        <span class="star word-star" id="star2"></span>
        <span class="star word-star" id="star3"></span>
        <span class="star sentence-star" id="star4"></span>
        <span class="star sentence-star" id="star5"></span>
        <span class="star sentence-star" id="star6"></span>
        <span class="star sentence-star" id="star7"></span>
    </div>


    <div id="scoring-standards" class="scoring-standards hidden">
        <h4>å¦‚ä½•ç²å¾—æ›´å¤šæ˜Ÿæ˜Ÿ?</h4>
        <ul>
            <li>â­ å¥å­ç¬¦åˆé¡Œç›®æ–‡æ³•æç¤ºè¦æ±‚</li>
            <li>â­ å¥å­ä½¿ç”¨äº†æ­£ç¢ºå–®å­—</li>
            <li>â­ æ²’æœ‰åŸºæœ¬æ–‡æ³•ã€æ‹¼å¯«å•é¡Œä¸”ç©ºæ ¼ä½¿ç”¨æ­£ç¢º</li>
            <li>â­ å¥å­è¡¨é”æµæš¢ï¼Œé”ä¸€å®šè¤‡é›œåº¦</li>  
        </ul>
    </div>


    <div id="game-box" class="game-box">
        <div id="left-side">
            <img id="vague-image" src="" alt="vague-image">
            <p>çŒœçŒœçœ‹åœ–ç‰‡ä¸­æœ‰ä»€éº¼ï¼Ÿ</p>
        </div>
        <div id="right-side">
            <div id="tip-boxes">
                <div class="tip-box" id="tip1"></div>
                <div class="tip-box" id="tip2"></div>
                <div class="tip-box" id="tip3"></div>
            </div>
            <div id="answer-boxes">
                <div class="answer-box" id="answer1"></div>
                <div class="answer-box" id="answer2"></div>
                <div class="answer-box" id="answer3"></div>
            </div>
        </div>
    </div>
    <div class="sentence" id="sentence">
        <p>è«‹ç”¨é¸æ“‡çš„ä¸‰å€‹å–®å­—é€ ä¸€å€‹å¥å­</p>
        <input type="text" id="sentence-input" placeholder="åœ¨é€™è£¡è¼¸å…¥æ‚¨çš„è‹±æ–‡å¥å­..." class="sentence-input">
        <div id="sentence-feedback" class="sentence-feedback" style="color:#c0392b;margin-top:8px;"></div>
        <button id="confirm-sentence-btn" class="confirm-sentence-btn hidden">ç¢ºèªé€ å¥</button>
        <button id="generate-image-btn" class="hidden">ç”Ÿæˆåœ–ç‰‡</button>
    </div>


    <div id="answer-area" class="answer-area">
        <div class="word-card">
            <div class="cards">
            </div>
            <div id="confirm" class="confirm">
                <button class="check-words-btn hidden">æª¢æŸ¥å–®å­—</button>
            </div>
        </div>
        <div class="feed-back">
            <div id="feedback-container"></div>
        </div>
    </div>
    <div id="message-box" class="message-box hidden">
        åªèƒ½é¸ä¸‰å¼µå™¢ï¼
    </div>


    <div id="image-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-body">
                <h3>æ‚¨ç”¨å¥å­ç”Ÿæˆçš„åœ–ç‰‡å¦‚ä¸‹ï¼š</h3>
                <img id="generated-image" src="" alt="Generated Image">
            </div>
            <div class="modal-footer">
                <button id="replay-btn">å†ç©ä¸€æ¬¡</button>
                <button id="next-level-btn">ä¸‹ä¸€é—œ</button>
            </div>
        </div>
    </div>


    <script>
        // =============== å…¨åŸŸè®Šæ•¸ ===============
        let currentLevel = 1;
        let levelDataCache = [];
        let currentSentencePrompt = "";
        // ğŸ¯ é—œéµè®Šæ•¸ï¼šè¿½è¹¤ AI æ˜¯å¦å·²å®Œæˆä¸€æ¬¡å›é¥‹ (ç”¨æ–¼æ§åˆ¶åœ–ç‰‡æŒ‰éˆ•)
        let hasAIProvidedFeedback = false;
        // è¿½è¹¤å–®å­—æ˜¯å¦å…¨å° (åƒ…ç”¨æ–¼ç­”æ¡ˆæ¡†é–å®š)
        let hasAIProvidedAllCorrectFeedback = false;


        // 42 å¼µå­—å¡
        const words = [
            "universe","crocodile","jellyfish","farm","cow","chicken","turtle","umbrella","raining",
            "pigeon","penguin","fence","waterfall","elephant","bird","bunny","desert","wolf","rock",
            "zebra","lion","boat","ocean","whale","cat","moon","night","koala","ice","grass","puppy",
            "parrot","forest","snow","rose","duck","tiger","horse","goose","mountain","dessert","fish"
        ];
       
        // ================= é—œå¡æ§åˆ¶å‡½å¼ ===================


        /**
         * ğŸ¯ è¼‰å…¥æŒ‡å®šé—œå¡çš„è³‡æ–™ä¸¦æ›´æ–°ç•«é¢ (æ ¸å¿ƒé‡ç½®/è¼‰å…¥é‚è¼¯)
         * @param {number} level - è¦è¼‰å…¥çš„é—œå¡ç·¨è™Ÿ
         */
        function loadLevel(level) {
            if (level > levelDataCache.length) {
                alert("æ­å–œæ‚¨å®Œæˆæ‰€æœ‰é—œå¡ï¼ç¾åœ¨å°‡å›åˆ°ç¬¬ä¸€é—œã€‚");
                level = 1;
            }


            const levelData = levelDataCache.find(item => item.level === level);
           
            if (!levelData) {
                console.error(`æ‰¾ä¸åˆ°é—œå¡ ${level} çš„è³‡æ–™ã€‚`);
                return;
            }


            currentLevel = level;
            // é‡è¨­ AI å›é¥‹æ¨™èªŒ
            hasAIProvidedFeedback = false;
            hasAIProvidedAllCorrectFeedback = false;
            // é‡è¨­å–®å­—æª¢æŸ¥æ——æ¨™ï¼Œé¿å…ä¸Šä¸€é—œçš„æª¢æŸ¥ç‹€æ…‹å½±éŸ¿æœ¬é—œ
            wordsCheckedFlag = false;


            // 1. æ›´æ–°é—œå¡æŒ‡ç¤ºå™¨
            const circles = document.querySelectorAll(".level-circle");
            circles.forEach(circle => {
                circle.classList.remove("active");
                if (parseInt(circle.textContent) === level) {
                    circle.classList.add("active");
                }
            });


            // 2. æ›´æ–°åœ–ç‰‡å’Œæç¤º
            document.getElementById("vague-image").src = levelData.image_vague;
            document.getElementById("tip1").textContent = levelData.tip[0];
            document.getElementById("tip2").textContent = levelData.tip[1];
            document.getElementById("tip3").textContent = levelData.tip[2];


            // 3. é‡è¨­ç­”æ¡ˆå€ã€é€ å¥å€ã€å›é¥‹å€
            const answerBoxes = document.querySelectorAll(".answer-box");
            const cardsContainer = document.querySelector(".cards");


            answerBoxes.forEach(box => {
                const word = box.textContent.trim();
                box.textContent = "";
                box.classList.remove("incorrect", "correct", "correct-locked");
               
                if (word && !cardsContainer.querySelector(`[data-word="${word}"]`)) {
                    const card = document.createElement("div");
                    card.className = "card";
                    card.dataset.word = word;
                    card.textContent = word;
                    cardsContainer.appendChild(card);
                }
            });
           
            document.getElementById("sentence-input").value = "";
            document.getElementById("feedback-container").innerHTML = "";
           
            // é‡è¨­æ˜Ÿæ˜Ÿç‚ºæš—
            document.querySelectorAll(".star").forEach(star => star.classList.remove("lit"));
           
            // éš±è—è©•åˆ†æ¨™æº–
            document.getElementById("scoring-standards").classList.add("hidden");
           
            renderCards();
            setSentencePrompt(levelData);
           
            document.querySelector(".confirm-btn").classList.add("hidden");
            document.getElementById("generate-image-btn").classList.add("hidden");
        }




        // ç”¢ç”Ÿå­—å¡ (ä¿æŒä¸è®Š)
        function renderCards() {
            const cardsContainer = document.querySelector(".cards");
           
            const takenWords = Array.from(document.querySelectorAll(".answer-box"))
                                             .map(box => box.textContent.trim())
                                             .filter(word => word !== "");


            cardsContainer.innerHTML = "";
            const sortedWords = [...words].sort();
            sortedWords.forEach(word => {
                if (takenWords.includes(word)) return;


                const card = document.createElement("div");
                card.className = "card";
                card.textContent = word;
                card.dataset.word = word;
                cardsContainer.appendChild(card);
            });
        }
       
        // è¨­å®šå¥å­æç¤º (ä¿æŒä¸è®Š)
        function setSentencePrompt(levelData) {
            const promptElement = document.querySelector("#sentence p");
            if (levelData && levelData.sentence && levelData.sentence.length > 0) {
                const randomIndex = Math.floor(Math.random() * levelData.sentence.length);
                const randomPrompt = levelData.sentence[randomIndex];
                currentSentencePrompt = randomPrompt;
                promptElement.innerHTML = `è«‹ç”¨é¸æ“‡çš„ä¸‰å€‹å–®å­—é€ ä¸€å€‹å¥å­ (${randomPrompt})`;
            } else {
                currentSentencePrompt = "";
                promptElement.innerHTML = `è«‹ç”¨é¸æ“‡çš„ä¸‰å€‹å–®å­—é€ ä¸€å€‹å¥å­`;
            }
        }


        // é¡¯ç¤ºè¨Šæ¯æ¡†ï¼ˆ1 ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼‰ (ä¿æŒä¸è®Š)
        function showMessage(msg) {
            const box = document.getElementById("message-box");
            box.textContent = msg;
            box.classList.add("show");
            setTimeout(() => {
                box.classList.remove("show");
            }, 1000);
        }


        // é»æ“Šå­—å¡ â†’ å¡«å…¥ç­”æ¡ˆå€ (ä¿æŒä¸è®Š)
        function setupCardEvents() {
            document.querySelector(".cards").addEventListener("click", e => {
                if (!e.target.classList.contains("card")) return;
                const word = e.target.dataset.word;
                const boxes = [
                    document.getElementById("answer1"),
                    document.getElementById("answer2"),
                    document.getElementById("answer3")
                ];
                const targetBox = boxes.find(box => box.textContent === "");
                if (!targetBox) {
                    showMessage("åªèƒ½é¸ä¸‰å¼µå™¢ï¼");
                    return;
                }
                targetBox.textContent = word;
                e.target.remove();
                // ç­”æ¡ˆå€æœ‰è®Šå‹•ï¼Œé‡ç½®ã€Œå·²æª¢æŸ¥å–®å­—ã€æ——æ¨™ï¼Œä½¿ç”¨è€…éœ€é‡æ–°æŒ‰ä¸€æ¬¡æª¢æŸ¥
                wordsCheckedFlag = false;
                updateCheckWordsButton();
                updateConfirmSentenceButton();
                updateImageButtonVisibility();
            });
        }


        // é»æ“Šç­”æ¡ˆ â†’ æ–‡å­—å›å»å­—å¡å€
        function setupAnswerBoxEvents() {
            const boxes = document.querySelectorAll(".answer-box");
            boxes.forEach(box => {
                box.addEventListener("click", () => {
                    if (box.textContent === "") return;
                   
                    // ğŸ¯ å¦‚æœå–®å­—å·²è¢«é–å®šï¼Œå‰‡ä¸èƒ½é»æ“Š
                    if (box.classList.contains("correct-locked")) {
                        showMessage("å–®å­—å·²ç­”å°ï¼Œè«‹å°ˆæ³¨æ–¼é€ å¥ï¼");
                        return;
                    }
                   
                    const word = box.textContent;
                    box.textContent = "";
                    box.classList.remove("incorrect", "correct");
                    // ç­”æ¡ˆè¢«ç§»é™¤ï¼Œéœ€é‡æ–°æª¢æŸ¥å–®å­—
                    wordsCheckedFlag = false;
                   
                    const card = document.createElement("div");
                    card.className = "card";
                    card.dataset.word = word;
                    card.textContent = word;
                   
                    const cardsContainer = document.querySelector(".cards");
                    const existingCards = Array.from(cardsContainer.children);
                    let inserted = false;
                    for (let i = 0; i < existingCards.length; i++) {
                        if (word.localeCompare(existingCards[i].textContent) < 0) {
                            cardsContainer.insertBefore(card, existingCards[i]);
                            inserted = true;
                            break;
                        }
                    }
                    if (!inserted) {
                        cardsContainer.appendChild(card);
                    }
                    updateCheckWordsButton();
                    updateConfirmSentenceButton();
                    updateImageButtonVisibility();
                });
            });
        }


        /**
         * æ ¹æ“šAIå›é¥‹è©•ä¼°å¥å­æ­£ç¢ºç‡ä¸¦è¨­ç½®å¥å­æ˜Ÿæ˜Ÿ
         * @param {string} aiFeedback - AIçš„å›é¥‹æ–‡å­—
         * @param {Array} correctWords - æ­£ç¢ºå–®å­—åˆ—è¡¨
         * @param {Array} userWords - ä½¿ç”¨è€…é¸æ“‡çš„å–®å­—
         * @param {string} userSentence - ä½¿ç”¨è€…è¼¸å…¥çš„å¥å­
         */
        function evaluateSentenceAndSetStars(aiFeedback, correctWords, userWords, userSentence) {
            let stars = 0;
            const feedback = aiFeedback.toLowerCase();

            // å‰ç«¯ç°¡æ˜“æª¢æŸ¥ï¼šæ¨™é»/ç©ºæ ¼éŒ¯èª¤èˆ‡ä¸»è¬‚ä¸€è‡´ï¼ˆå•Ÿç™¼å¼ï¼‰
            const punctuationSpacingIssue = /\s[.,!?;:]|[.,!?;:](?!\s|$)|\s{2,}/.test(userSentence);
            const subjectVerbIssue = (function(){
                const m = userSentence.match(/\b(he|she|it)\b\s+\b(?!is|are|was|were|has|have|had|does|do|did|will|would|can|could|should|may|might|must|be|been|being)([a-z]+)\b/i);
                return m ? !/s$/.test(m[2]) : false;
            })();
            const pluralSubjectVerbIssue = (function(){
                const m = userSentence.match(/\b(we|they|you)\b\s+\b([a-z]+s)\b/i);
                return m ? true : false;
            })();
            const aBeforePluralNoun = /\ba\s+[a-z]+s\b/i.test(userSentence);
            const subjectVerbAgreementIssue = subjectVerbIssue || pluralSubjectVerbIssue || aBeforePluralNoun;
            
            // åˆä½µå–®å­—æª¢æŸ¥ï¼ˆå•Ÿç™¼å¼ï¼‰
            const letterTokensConcat = userSentence.match(/[A-Za-z]+/g) || [];
            let concatenatedDetected = false;
            for (const tok of letterTokensConcat) {
                let matched = 0;
                for (const w of correctWords) {
                    if (tok.toLowerCase().includes(w.toLowerCase())) matched++;
                }
                if (matched >= 2) { concatenatedDetected = true; break; }
            }
            if (concatenatedDetected) {
                const note = document.getElementById("sentence-feedback");
                if (note) note.textContent = "æª¢æ¸¬åˆ°è‹±æ–‡å–®å­—æœªä»¥ç©ºæ ¼åˆ†éš”ï¼Œè«‹åœ¨å–®å­—é–“åŠ å…¥ç©ºæ ¼ã€‚ç¬¬ä¸‰é¡†æ˜Ÿéœ€æ­£ç¢ºç©ºæ ¼èˆ‡æ¨™é»ã€‚";
            }

            // æª¢æ¸¬é€£çºŒåè©åˆ—èˆ‰ä½†ç¼ºå°‘é€—è™Ÿæˆ–é€£æ¥è©ï¼ˆä¾‹å¦‚ 'the duck roses snow'ï¼‰
            let listingWithoutSeparator = false;
            try {
                const cw = correctWords.map(w => w.toLowerCase());
                outer: for (let i = 0; i < cw.length; i++) {
                    for (let j = 0; j < cw.length; j++) {
                        if (i === j) continue;
                        const pattern = new RegExp('\\b' + cw[i] + '\\b\\s+\\b' + cw[j] + '\\b', 'i');
                        if (pattern.test(userSentence)) { listingWithoutSeparator = true; break outer; }
                    }
                }
                if (listingWithoutSeparator) {
                    const note = document.getElementById("sentence-feedback");
                    if (note) note.textContent = "æª¢æ¸¬åˆ°é€£çºŒåè©åˆ—èˆ‰ç¼ºå°‘é€—è™Ÿæˆ–é€£æ¥è©ï¼Œè«‹ä½¿ç”¨é€—è™Ÿæˆ–åŠ ä¸Š 'and' (ä¾‹å¦‚ï¼šthe duck, the roses, and the snow)ã€‚ç¬¬ä¸‰é¡†æ˜Ÿéœ€æ­£ç¢ºæ¨™é»èˆ‡ä¸»è¬‚ä¸€è‡´ã€‚";
                }
            } catch (e) {
                // å¿½ç•¥æ­£å‰‡éŒ¯èª¤ï¼Œä»¥é˜²ç‰¹æ®Šå­—å…ƒå¹²æ“¾
            }
            
            // éšå±¤å¼è©•ä¼°æ˜Ÿæ˜Ÿ
            // æ¢ä»¶1ï¼šå¥å­ç¬¦åˆé¡Œç›®æ–‡æ³•æç¤ºè¦æ±‚ (åŸºæœ¬æ¢ä»¶)
            const condition1 = (feedback.includes('ç¬¦åˆ') || feedback.includes('æ­£ç¢º')) && !feedback.includes('ä¸ç¬¦åˆ') && !feedback.includes('ä¸ç¬¦');
            if (!condition1) {
                stars = 0; // ä¸ç¬¦åˆæç¤ºè¦æ±‚ï¼Œç„¡æ³•ç²å¾—ä»»ä½•æ˜Ÿæ˜Ÿ
            } else {
                stars = 1; // è‡³å°‘ç²å¾—1é¡†æ˜Ÿæ˜Ÿ
               
                // æ¢ä»¶2ï¼šå¥å­ä½¿ç”¨äº†æ­£ç¢ºå–®å­— (å¿…é ˆå…ˆæ»¿è¶³æ¢ä»¶1)
                const sentenceWords = userSentence.toLowerCase().split(/\s+/).filter(word => word.length > 0);
                const usedCorrectWords = correctWords.filter(word =>
                    sentenceWords.some(sentenceWord => sentenceWord.includes(word) || word.includes(sentenceWord))
                );
                const condition2 = usedCorrectWords.length >= 3; // å¿…é ˆä½¿ç”¨ä¸‰å€‹ç¬¦åˆåœ–ç‰‡çš„æ­£ç¢ºå–®å­—
               
                if (condition2) {
                    stars = 2; // ç²å¾—2é¡†æ˜Ÿæ˜Ÿ
                   
                    // æ¢ä»¶3ï¼šå®Œå…¨æ²’æœ‰æ–‡æ³•ã€æ‹¼å¯«ã€å–®è¤‡æ•¸æˆ–ä¸»è¬‚ä¸€è‡´å•é¡Œï¼Œä¸”æ¨™é»/ç©ºæ ¼ä½¿ç”¨æ­£ç¢º (å¿…é ˆå…ˆæ»¿è¶³æ¢ä»¶1å’Œ2)
                    const condition3 = (
                        // æ¥å—å¾Œç«¯æ˜ç¢ºæ¨™è¨»æˆ–åŒ…å«æ­å–œå¥é–‹é ­ï¼Œä»£è¡¨å®Œå…¨æ­£ç¢º
                        (feedback.startsWith('æ­å–œä½ å®Œå…¨ç­”å°äº†') || feedback.includes('æ–‡æ³•æ­£ç¢º') || feedback.includes('èªæ³•æ­£ç¢º') || feedback.includes('å–®è¤‡æ•¸èˆ‡ä¸»è¬‚ä¸€è‡´çš†æ­£ç¢º') || feedback.includes('æ¨™é»èˆ‡ç©ºæ ¼çš†æ­£ç¢º') || feedback.includes('æ¨™é»åŠç©ºæ ¼çš†æ­£ç¢º')) &&
                        // ä¸¦ä¸”ä¸åŒ…å«ä»»ä½•å¸¸è¦‹éŒ¯èª¤æç¤ºæ–‡å­—
                        !feedback.includes('æ–‡æ³•éŒ¯èª¤') && !feedback.includes('èªæ³•éŒ¯èª¤') &&
                        !feedback.includes('å¤§å°å¯«éŒ¯èª¤') && !feedback.includes('æ‹¼å¯«éŒ¯èª¤') &&
                        !feedback.includes('å–®è¤‡æ•¸éŒ¯èª¤') && !feedback.includes('å–®è¤‡æ•¸') &&
                        !feedback.includes('å–®æ•¸') && !feedback.includes('è¤‡æ•¸') &&
                        !feedback.includes('ä¸»è©å‹•è©') && !feedback.includes('ä¸»è¬‚ä¸€è‡´') && !feedback.includes('ä¸»è©èˆ‡å‹•è©') &&
                        !feedback.includes('æ¨™é»éŒ¯èª¤') && !feedback.includes('æ¨™é»ä¸æ­£ç¢º') && !feedback.includes('ç©ºæ ¼éŒ¯èª¤') && !feedback.includes('å¤šé¤˜ç©ºæ ¼') &&
                        // å‰ç«¯å•Ÿç™¼å¼æª¢æŸ¥ä¹Ÿå¿…é ˆé€šéï¼ŒåŒ…å«ä¸å¾—æœ‰é€£çºŒåè©æœªç”¨é€—è™Ÿ/andåˆ†éš”
                        !punctuationSpacingIssue && !subjectVerbAgreementIssue && !concatenatedDetected && !listingWithoutSeparator
                    );
                    if (condition3) {
                        stars = 3; // ç²å¾—3é¡†æ˜Ÿæ˜Ÿ
                       
                        // æ¢ä»¶4ï¼šå¥å­è¡¨é”æµæš¢ï¼Œé”ä¸€å®šè¤‡é›œåº¦ (å¿…é ˆå…ˆæ»¿è¶³æ¢ä»¶1ã€2ã€3)
                        const wordCount = userSentence.split(/\s+/).filter(word => word.length > 0).length;
                        const hasAdjective = /\b(beautiful|big|small|happy|sad|red|blue|green|yellow|white|black|brown|fast|slow|cold|hot|new|old|good|bad|nice|ugly)\b/i.test(userSentence);
                        const hasConjunction = /\b(and|but|or|because|although|when|where|why|how|so|then|after|before)\b/i.test(userSentence);
                        const condition4 = (hasAdjective || hasConjunction) && wordCount >= 6; // åŒ…å«å½¢å®¹è©æˆ–é€£æ¥è©ï¼Œä¸”å¥å­è¼ƒé•·
                       
                        if (condition4) {
                            stars = 4; // ç²å¾—4é¡†æ˜Ÿæ˜Ÿ
                        }
                    }
                }
            }
           
            // è¨­ç½®å¥å­æ˜Ÿæ˜Ÿé¡¯ç¤ºï¼ˆæ˜Ÿæ˜Ÿ4-7ï¼‰
            document.querySelectorAll(".sentence-star").forEach((star, index) => {
                if (index < stars) {
                    star.classList.add("lit");
                } else {
                    star.classList.remove("lit");
                }
            });


            // é¡¯ç¤ºè©•åˆ†æ¨™æº–
            const scoringStandards = document.getElementById("scoring-standards");
            if (stars > 0) {
                scoringStandards.classList.remove("hidden");
            } else {
                scoringStandards.classList.add("hidden");
            }
        }




        // è¨­å®šé€ å¥è¼¸å…¥æ¡†çš„ç›£è½äº‹ä»¶ (ä¿æŒä¸è®Š)
        function setupInputListener() {
            const sentenceInput = document.getElementById("sentence-input");
            if (sentenceInput) {
                sentenceInput.addEventListener("input", () => {
                    updateCheckWordsButton();
                    updateConfirmSentenceButton();
                    updateImageButtonVisibility();
                });
            }
        }




        // å…¨åŸŸæ——æ¨™ï¼šæ˜¯å¦å·²æŒ‰éã€Œæª¢æŸ¥å–®å­—ã€æŒ‰éˆ•
        let wordsCheckedFlag = false;

        // æ›´æ–°æª¢æŸ¥å–®å­—æŒ‰éˆ•æ˜¯å¦é¡¯ç¤ºçš„é‚è¼¯
        function updateCheckWordsButton() {
            const btn = document.querySelector(".check-words-btn");
            if (!btn) return;

            const a1 = document.getElementById("answer1").textContent.trim();
            const a2 = document.getElementById("answer2").textContent.trim();
            const a3 = document.getElementById("answer3").textContent.trim();
           
            const shouldShow = (a1 !== "" && a2 !== "" && a3 !== "");


            btn.classList.toggle("hidden", !shouldShow);
        }


        // æ›´æ–°ç¢ºèªé€ å¥æŒ‰éˆ•æ˜¯å¦é¡¯ç¤ºçš„é‚è¼¯
        function updateConfirmSentenceButton() {
            const btn = document.getElementById("confirm-sentence-btn");
            if (!btn) return;


            const sentenceInput = document.getElementById("sentence-input");
            const sentenceFilled = sentenceInput && sentenceInput.value.trim() !== "";
            // è‹¥ä½¿ç”¨è€…å·²æŒ‰éã€Œæª¢æŸ¥å–®å­—ã€æˆ–è‡³å°‘æœ‰ä¸€å€‹å–®å­—æ˜Ÿæ˜Ÿäº®èµ·ï¼Œå‰‡è¦–ç‚ºå·²æª¢æŸ¥
            const wordsChecked = (document.querySelector(".word-star.lit") !== null) || wordsCheckedFlag;


            const shouldShow = sentenceFilled && wordsChecked;


            btn.classList.toggle("hidden", !shouldShow);
        }


        /**
         * æ ¹æ“šé€ å¥å®Œæˆåº¦è©•ä¼°ä¸¦è¨­ç½®å¥å­æ˜Ÿæ˜Ÿï¼ˆéšå±¤å¼ï¼‰
         */
        function evaluateSentenceCompletion() {
            const sentenceInput = document.getElementById("sentence-input");
            const userSentence = sentenceInput.value.trim();
            const levelData = levelDataCache.find(item => item.level === currentLevel);
           
            if (!levelData) return;


            const correctWords = levelData.answer.map(w => w.toLowerCase());
            const userBoxes = [
                document.getElementById("answer1"),
                document.getElementById("answer2"),
                document.getElementById("answer3")
            ];
            const userWords = userBoxes.map(box => box.textContent.trim().toLowerCase()).filter(word => word !== "");


            let stars = 0;


            // æº–å‚™æª¢æŸ¥è®Šæ•¸
            const sentenceWords = userSentence.toLowerCase().split(/\s+/).filter(word => word.length > 0);
            const wordCount = sentenceWords.length;

            // æª¢æŸ¥æ˜¯å¦æœ‰åˆä½µè‹±æ–‡å–®å­—ï¼ˆä¾‹å¦‚ 'duckrosessnow'ï¼‰ï¼Œå¦‚æœç™¼ç¾åˆä½µä¸”è©²å­—ä¸²åŒ…å«å…©å€‹æˆ–ä»¥ä¸Šçš„æ­£ç¢ºå–®å­—ï¼Œåˆ¤å®šç‚ºéŒ¯èª¤ä¸¦ç›´æ¥ä¸çµ¦æ˜Ÿ
            const letterTokens = userSentence.match(/[A-Za-z]+/g) || [];
            let concatenatedDetected = false;
            for (const tok of letterTokens) {
                let matched = 0;
                for (const w of levelData.answer) {
                    if (tok.toLowerCase().includes(w.toLowerCase())) matched++;
                }
                if (matched >= 2) {
                    concatenatedDetected = true;
                    break;
                }
            }
            if (concatenatedDetected) {
                // ç™¼ç¾åˆä½µå–®å­—ï¼šæç¤ºä½¿ç”¨è€…ï¼Œä½†ä¸è¦ç›´æ¥è¿”å›ï¼Œè®“æµç¨‹ç¹¼çºŒä»¥ä¾¿ä»èƒ½çµ¦äºˆå‰å…©éšæ®µçš„æ˜Ÿæ˜Ÿï¼ˆç¬¬ä¸‰éšæ®µæœƒå› åˆä½µå–®å­—å¤±æ•—è€Œä¸çµ¦ï¼‰ã€‚
                const note = document.getElementById("sentence-feedback");
                if (note) note.textContent = "æª¢æ¸¬åˆ°è‹±æ–‡å–®å­—æœªä»¥ç©ºæ ¼åˆ†éš”ï¼Œè«‹åœ¨å–®å­—é–“åŠ å…¥ç©ºæ ¼ã€‚ç¬¬ä¸‰é¡†æ˜Ÿéœ€æ­£ç¢ºç©ºæ ¼èˆ‡æ¨™é»ã€‚";
                // ä¿ç•™ concatenatedDetected = true ä¾›å¾ŒçºŒåˆ¤æ–·ä½¿ç”¨
            }

            // æª¢æ¸¬é€£çºŒåè©åˆ—èˆ‰ä½†ç¼ºå°‘é€—è™Ÿæˆ–é€£æ¥è©ï¼ˆä¾‹å¦‚ 'the duck roses snow'ï¼‰
            let listingWithoutSeparator = false;
            try {
                const cw = levelData.answer.map(w => w.toLowerCase());
                outer: for (let i = 0; i < cw.length; i++) {
                    for (let j = 0; j < cw.length; j++) {
                        if (i === j) continue;
                        const pattern = new RegExp('\\b' + cw[i] + '\\b\\s+\\b' + cw[j] + '\\b', 'i');
                        if (pattern.test(userSentence)) { listingWithoutSeparator = true; break outer; }
                    }
                }
                if (listingWithoutSeparator) {
                    const note = document.getElementById("sentence-feedback");
                    if (note) note.textContent = "æª¢æ¸¬åˆ°é€£çºŒåè©åˆ—èˆ‰ç¼ºå°‘é€—è™Ÿæˆ–é€£æ¥è©ï¼Œè«‹ä½¿ç”¨é€—è™Ÿæˆ–åŠ ä¸Š 'and' (ä¾‹å¦‚ï¼šthe duck, the roses, and the snow)ã€‚ç¬¬ä¸‰é¡†æ˜Ÿéœ€æ­£ç¢ºæ¨™é»èˆ‡ä¸»è¬‚ä¸€è‡´ã€‚";
                }
            } catch (e) {
                // å¿½ç•¥æ­£å‰‡éŒ¯èª¤ï¼Œä»¥é˜²ç‰¹æ®Šå­—å…ƒå¹²æ“¾
            }

            const hasSubject = /\b(I|you|he|she|it|we|they|the|a|an|this|that|these|those)\b/i.test(userSentence);
            const hasVerb = /\b(is|am|are|was|were|be|been|being|have|has|had|do|does|did|will|would|can|could|should|may|might|must|shall)\b/i.test(userSentence);
            const properCapitalization = /^[A-Z]/.test(userSentence); // å¥å­é–‹é ­å¤§å¯«
            const hasProperEnding = /[.!?]$/.test(userSentence); // å¥å­çµå°¾æœ‰æ¨™é»
            const hasAdjective = /\b(beautiful|big|small|happy|sad|red|blue|green|yellow|white|black|brown|fast|slow|cold|hot|new|old|good|bad|nice|ugly)\b/i.test(userSentence);
            const hasConjunction = /\b(and|but|or|because|although|when|where|why|how|so|then|after|before)\b/i.test(userSentence);


            // éšå±¤å¼è©•ä¼°æ˜Ÿæ˜Ÿ
            // æ¢ä»¶1ï¼šå¥å­ç¬¦åˆé¡Œç›®æ–‡æ³•æç¤ºè¦æ±‚ (åŸºæœ¬æ¢ä»¶) - æª¢æŸ¥å¥å­åŒ…å«é¡Œç›®ä¸­æ‰€è¦æ±‚çš„æ–‡æ³•ï¼ˆThese/Those/They are æˆ– What is/are ... doing?ï¼‰
            const hasTheseThoseTheyAre = /\b(these|those|they are)\b/i.test(userSentence);
            const hasWhatIsAreDoing = /\bwhat (is|are) .+ doing\b/i.test(userSentence);
            const condition1 = hasTheseThoseTheyAre || hasWhatIsAreDoing; // å¥å­å¿…é ˆæ ¹æ“šæç¤ºä½¿ç”¨ These/Those/They are æˆ– What is/are ... doing? å¥å‹
           
            if (!condition1) {
                stars = 0; // ä¸ç¬¦åˆåŸºæœ¬è¦æ±‚ï¼Œç„¡æ³•ç²å¾—ä»»ä½•æ˜Ÿæ˜Ÿ
            } else {
                stars = 1; // è‡³å°‘ç²å¾—1é¡†æ˜Ÿæ˜Ÿ
               
                // æ¢ä»¶2ï¼šå¥å­ä½¿ç”¨äº†æ­£ç¢ºå–®å­— (å¿…é ˆå…ˆæ»¿è¶³æ¢ä»¶1)
                const usedCorrectWords = correctWords.filter(word =>
                    sentenceWords.some(sentenceWord => sentenceWord.includes(word) || word.includes(sentenceWord))
                );
                const condition2 = usedCorrectWords.length >= 3; // å¿…é ˆä½¿ç”¨ä¸‰å€‹ç¬¦åˆåœ–ç‰‡çš„æ­£ç¢ºå–®å­—
               
                if (condition2) {
                    stars = 2; // ç²å¾—2é¡†æ˜Ÿæ˜Ÿ
                   
                    // å‰ç«¯ï¼šæ¨™é»/ç©ºæ ¼æª¢æŸ¥èˆ‡ä¸»è¬‚ä¸€è‡´å•Ÿç™¼å¼æª¢æŸ¥
                    const punctuationSpacingIssue = /\s[.,!?;:]|[.,!?;:](?!\s|$)|\s{2,}/.test(userSentence);
                    const subjectVerbIssue = (function(){
                        const m = userSentence.match(/\b(he|she|it)\b\s+\b(?!is|are|was|were|has|have|had|does|do|did|will|would|can|could|should|may|might|must|be|been|being)([a-z]+)\b/i);
                        return m ? !/s$/.test(m[2]) : false;
                    })();
                    const pluralSubjectVerbIssue = (function(){
                        const m = userSentence.match(/\b(we|they|you)\b\s+\b([a-z]+s)\b/i);
                        return m ? true : false;
                    })();
                    const aBeforePluralNoun = /\ba\s+[a-z]+s\b/i.test(userSentence);
                    const subjectVerbAgreementIssue = subjectVerbIssue || pluralSubjectVerbIssue || aBeforePluralNoun;

                    // æ¢ä»¶3ï¼šå®Œå…¨æ²’æœ‰æ–‡æ³•ã€æ‹¼å¯«ã€å–®è¤‡æ•¸æˆ–ä¸»è¬‚ä¸€è‡´å•é¡Œï¼Œä¸”æ¨™é»/ç©ºæ ¼ä½¿ç”¨æ­£ç¢º (å¿…é ˆå…ˆæ»¿è¶³æ¢ä»¶1å’Œ2)
                    const condition3 = hasSubject && hasVerb && properCapitalization && hasProperEnding && !punctuationSpacingIssue && !subjectVerbAgreementIssue && !concatenatedDetected && !listingWithoutSeparator;
                   
                    if (condition3) {
                        stars = 3; // ç²å¾—3é¡†æ˜Ÿæ˜Ÿ
                       
                        // æ¢ä»¶4ï¼šå¥å­è¡¨é”æµæš¢ï¼Œé”ä¸€å®šè¤‡é›œåº¦ (å¿…é ˆå…ˆæ»¿è¶³æ¢ä»¶1ã€2ã€3)
                        const condition4 = (hasAdjective || hasConjunction) && wordCount >= 6; // åŒ…å«å½¢å®¹è©æˆ–é€£æ¥è©ï¼Œä¸”å¥å­è¼ƒé•·
                       
                        if (condition4) {
                            stars = 4; // ç²å¾—4é¡†æ˜Ÿæ˜Ÿ
                        }
                    }
                }
            }


            // è¨­ç½®å¥å­æ˜Ÿæ˜Ÿé¡¯ç¤ºï¼ˆæ˜Ÿæ˜Ÿ4-7ï¼‰
            document.querySelectorAll(".sentence-star").forEach((star, index) => {
                if (index < stars) {
                    star.classList.add("lit");
                } else {
                    star.classList.remove("lit");
                }
            });


            // é¡¯ç¤ºè©•åˆ†æ¨™æº–
            const scoringStandards = document.getElementById("scoring-standards");
            if (stars > 0) {
                scoringStandards.classList.remove("hidden");
            } else {
                scoringStandards.classList.add("hidden");
            }
        }
       
        // ================= AI åŠŸèƒ½å‡½æ•¸ (å¯¦éš›å‘¼å« Flask å¾Œç«¯) ===================


        // æ‰“å­—æ•ˆæœ (ä¿æŒä¸è®Š)
        function typeEffect(elementId, text, delay = 50, callback = null) {
            const container = document.getElementById(elementId);
            if (!container) { if (callback) callback(); return; }
           
            container.innerHTML = '';
            const outputElement = document.createElement('pre');
            outputElement.className = 'ai-feedback-content';
            container.appendChild(outputElement);


            let i = 0;
            const feedBackBox = document.querySelector(".feed-back");


            function typing() {
                if (i < text.length) {
                    const char = text.charAt(i);
                    if (char === '\n') { outputElement.innerHTML += '<br>'; }
                    else { outputElement.textContent += char; }
                    i++;
                    setTimeout(typing, delay);
                    feedBackBox.scrollTop = feedBackBox.scrollHeight;
                } else {
                    if (callback) { callback(); }
                }
            }
            typing();
        }


        /**
         * ğŸ¯ ç™¼é€è«‹æ±‚çµ¦ Flask å¾Œç«¯ AI APIï¼Œä¸¦åœ¨å›é¥‹å¾Œç«‹å³é¡¯ç¤ºã€Œç”Ÿæˆåœ–ç‰‡ã€æŒ‰éˆ•
         */
        async function sendFeedbackToAI(level, missingWords, incorrectWords, userSentence, sentencePrompt, userWords, correctAnswers) {
            const feedbackContainer = document.getElementById("feedback-container");
            const confirmSentenceBtn = document.getElementById("confirm-sentence-btn");
            const imageBtn = document.getElementById("generate-image-btn");


            // 1. ç¦ç”¨æŒ‰éˆ•ä¸¦é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            confirmSentenceBtn.disabled = true;
            imageBtn.classList.add("hidden");
            feedbackContainer.innerHTML = `ğŸ¤– AI æ­£åœ¨æ€è€ƒä¸­ï¼Œè«‹ç¨å€™... <span class="loading-dot">.</span><span class="loading-dot">.</span><span class="loading-dot">.</span>`;
           
            let isAllCorrect = missingWords.length === 0;


            const payload = {
                level: level,
                missing_words: missingWords,        
                incorrect_words: incorrectWords,      
                user_sentence: userSentence,
                sentence_prompt: sentencePrompt,
                correct_words: userWords          
            };
           
            // æ¯æ¬¡æäº¤æ™‚ï¼Œé‡ç½®å›é¥‹ç‹€æ…‹
            hasAIProvidedFeedback = false;
            hasAIProvidedAllCorrectFeedback = isAllCorrect; // ä»ç”¨æ–¼å–®å­—é–å®š


            try {
                // 3. å¯¦éš›ç™¼é€ POST è«‹æ±‚
                const response = await fetch("/api/ai_feedback", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
               
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API æœå‹™éŒ¯èª¤: ${response.status}. è©³ç´°è³‡è¨Š: ${errorText.substring(0, 100)}`);
                }


                const result = await response.json();
                const aiFeedbackText = result.feedback || "AI æœå‹™æœªè¿”å›æœ‰æ•ˆå›é¥‹ã€‚";
               
                // 4. è™•ç†å›é¥‹é¡¯ç¤º
                const onTypingComplete = () => {
                    // ğŸ¯ é—œéµæ­¥é©Ÿï¼šåªè¦æ‰“å­—å®Œæˆï¼Œå°±å°‡ç‹€æ…‹æ¨™è¨˜ç‚ºå·²å›é¥‹
                    hasAIProvidedFeedback = true;
                    updateImageButtonVisibility();
                   
                    // æ ¹æ“šAIå›é¥‹è©•ä¼°å¥å­ä¸¦è¨­ç½®æ˜Ÿæ˜Ÿ
                    evaluateSentenceAndSetStars(aiFeedbackText, correctAnswers, userWords, userSentence);
                };
               
                typeEffect('feedback-container', aiFeedbackText, 30, onTypingComplete);


                // 5. å–®å­—é–å®šé‚è¼¯
                if (isAllCorrect) {
                    const userBoxes = [
                        document.getElementById("answer1"),
                        document.getElementById("answer2"),
                        document.getElementById("answer3")
                    ];
                    document.querySelectorAll(".answer-box").forEach(box => box.classList.remove("correct-locked"));


                    userBoxes.forEach(box => {
                        if (box.textContent.trim() !== "") {
                             box.classList.add("correct-locked");
                        }
                    });
                }
               
            } catch (error) {
                // è™•ç†ç¶²è·¯æˆ– API éŒ¯èª¤
                console.error('å‘¼å« AI æœå‹™å¤±æ•—:', error);
                const errorMessage = `é€£ç·šéŒ¯èª¤æˆ–å¾Œç«¯éŒ¯èª¤ï¼š${error.message}ã€‚è«‹æª¢æŸ¥æ‚¨çš„ Flask çµ‚ç«¯æ©Ÿæ—¥èªŒã€‚`;
                typeEffect('feedback-container', errorMessage, 30);
               
            } finally {
                confirmSentenceBtn.disabled = false;
            }
        }
       
        // ================= æ¨¡æ…‹è¦–çª—æ§åˆ¶ (ä¿æŒä¸è®Š) ===================


        /**
         * é¡¯ç¤ºåœ–ç‰‡çµæœæ¨¡æ…‹è¦–çª—
         */
        function showModal() {
            const levelData = levelDataCache.find(item => item.level === currentLevel);
            const fullImageUrl = levelData ? levelData.image_full : "/static/images/default_full.jpg";


            document.getElementById("generated-image").src = fullImageUrl;
            document.getElementById("image-modal").classList.add("visible");
            document.getElementById("generate-image-btn").classList.add("hidden");
        }


        /**
         * éš±è—åœ–ç‰‡çµæœæ¨¡æ…‹è¦–çª—
         */
        function hideModal() {
            document.getElementById("image-modal").classList.remove("visible");
            document.getElementById("generated-image").src = "";
        }




        // ================= DOM è¼‰å…¥èˆ‡éŠæˆ²ä¸»é‚è¼¯ ===================


        window.addEventListener("DOMContentLoaded", () => {
            setupCardEvents();
            setupAnswerBoxEvents();
            setupInputListener();


            // ğŸ¯ é»æ“Šã€Œç”Ÿæˆåœ–ç‰‡ã€æŒ‰éˆ•çš„äº‹ä»¶
            document.getElementById("generate-image-btn").addEventListener("click", showModal);


            // ğŸ¯ é»æ“Šã€Œå†ç©ä¸€æ¬¡ã€æŒ‰éˆ•çš„äº‹ä»¶
            document.getElementById("replay-btn").addEventListener("click", () => {
                hideModal();
                loadLevel(1); // å›åˆ°ç¬¬ä¸€é—œ
            });


            // ğŸ¯ é»æ“Šã€Œä¸‹ä¸€é—œã€æŒ‰éˆ•çš„äº‹ä»¶
            document.getElementById("next-level-btn").addEventListener("click", () => {
                hideModal();
                const nextLevel = currentLevel + 1;
                loadLevel(nextLevel); // è¼‰å…¥ä¸‹ä¸€é—œ
            });
        });


        // è¼‰å…¥é—œå¡è³‡æ–™
        fetch("/static/data/easy_mode.json")
            .then(response => {
                if (!response.ok) {
                    throw new Error(`ç„¡æ³•è¼‰å…¥ easy_mode.json: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                levelDataCache = data;
                loadLevel(1);
            })
            .catch(err => {
                console.error("è®€å– JSON å¤±æ•—:", err);
                // ä¸é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯çµ¦ç”¨æˆ¶ï¼Œåªåœ¨æ§åˆ¶å°è¨˜éŒ„
            });


        // æª¢æŸ¥å–®å­—æŒ‰éˆ•ï¼šæª¢æŸ¥å–®å­—ä¸¦çµ¦å–®å­—æ˜Ÿæ˜Ÿ
        document.querySelector(".check-words-btn").addEventListener("click", () => {
            const levelData = levelDataCache.find(item => item.level === currentLevel);


            if (!levelData) {
                console.error("æ‰¾ä¸åˆ°ç•¶å‰é—œå¡è³‡æ–™:", currentLevel);
                return;
            }


            const correctAnswers = levelData.answer.map(w => w.toLowerCase());
            const userBoxes = [
                document.getElementById("answer1"),
                document.getElementById("answer2"),
                document.getElementById("answer3")
            ];


            const userWords = userBoxes.map(box => box.textContent.trim().toLowerCase());
           
            const incorrectWords = [];
            const missingWords = correctAnswers.filter(word => !userWords.includes(word));


            // è¦–è¦ºæ¨™è¨˜ä½¿ç”¨è€…é¸æ“‡çš„å–®å­—æ˜¯å¦æ­£ç¢º
            userBoxes.forEach(box => {
                const userWord = box.textContent.trim().toLowerCase();
                box.classList.remove("correct", "incorrect", "correct-locked");


                if (correctAnswers.includes(userWord)) {
                    box.classList.add("correct");
                } else {
                    box.classList.add("incorrect");
                    if(userWord !== "") {
                        incorrectWords.push(userWord);
                    }
                }
            });


            // è¨­ç½®å–®å­—æ˜Ÿæ˜Ÿï¼ˆæ ¹æ“šæ­£ç¢ºå–®å­—æ•¸é‡ï¼‰
            const correctWordCount = userWords.filter(word => correctAnswers.includes(word)).length;
            document.querySelectorAll(".word-star").forEach((star, index) => {
                if (index < correctWordCount) {
                    star.classList.add("lit");
                } else {
                    star.classList.remove("lit");
                }
            });


            // åœ¨åé¥‹å€é¡¯ç¤ºæé†’è¨Šæ¯
            const feedbackContainer = document.getElementById("feedback-container");
            feedbackContainer.innerHTML = "ç¾åœ¨å¯ä»¥é–‹å§‹é€ å¥äº†ï¼";

            // æ¨™è¨˜å·²æŒ‰éæª¢æŸ¥æŒ‰éˆ•ï¼Œå…è¨±å³ä¾¿æ‰€æœ‰å–®å­—çš†éŒ¯ä¹Ÿé–‹å§‹é€ å¥
            wordsCheckedFlag = true;

            // æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
            updateConfirmSentenceButton();
        });

        // ç•¶ä½¿ç”¨è€…åœ¨é€ å¥æ¬„è¼¸å…¥æ™‚ï¼Œå‹•æ…‹æ›´æ–°ç¢ºèªé€ å¥æŒ‰éˆ•ï¼ˆç¢ºä¿å³ä½¿å–®å­—å…¨éŒ¯ã€æŒ‰éæª¢æŸ¥å¾Œä¹Ÿæœƒé¡¯ç¤ºï¼‰
        (function(){
            const sentenceInputEl = document.getElementById("sentence-input");
            if (sentenceInputEl) {
                sentenceInputEl.addEventListener("input", () => {
                    updateConfirmSentenceButton();
                    // ç·¨è¼¯å¥å­æ™‚æ¸…é™¤èˆŠæç¤ºä»¥é¿å…å¹²æ“¾
                    const note = document.getElementById("sentence-feedback");
                    if (note && note.textContent.trim().length > 0) note.textContent = "";
                });
            }
        })();


        // ç¢ºèªé€ å¥æŒ‰éˆ•ï¼šè§¸ç™¼ AI å›é¥‹ä¸¦çµ¦å¥å­æ˜Ÿæ˜Ÿ
        document.getElementById("confirm-sentence-btn").addEventListener("click", () => {
            const levelData = levelDataCache.find(item => item.level === currentLevel);


            if (!levelData) {
                console.error("æ‰¾ä¸åˆ°ç•¶å‰é—œå¡è³‡æ–™:", currentLevel);
                return;
            }


            const correctAnswers = levelData.answer.map(w => w.toLowerCase());
            const userBoxes = [
                document.getElementById("answer1"),
                document.getElementById("answer2"),
                document.getElementById("answer3")
            ];


            const userSentence = document.getElementById("sentence-input").value.trim();
            const userWords = userBoxes.map(box => box.textContent.trim().toLowerCase());
            const sentencePrompt = currentSentencePrompt;


           
            const incorrectWords = [];
            const missingWords = correctAnswers.filter(word => !userWords.includes(word));


            // è¦–è¦ºæ¨™è¨˜ä½¿ç”¨è€…é¸æ“‡çš„å–®å­—æ˜¯å¦æ­£ç¢ºï¼ˆå†æ¬¡ç¢ºèªï¼‰
            userBoxes.forEach(box => {
                const userWord = box.textContent.trim().toLowerCase();
                box.classList.remove("correct", "incorrect", "correct-locked");


                if (correctAnswers.includes(userWord)) {
                    box.classList.add("correct");
                } else {
                    box.classList.add("incorrect");
                    if(userWord !== "") {
                        incorrectWords.push(userWord);
                    }
                }
            });


            sendFeedbackToAI(
                currentLevel,
                missingWords,
                incorrectWords,
                userSentence,
                sentencePrompt,
                userWords,
                correctAnswers
            );


            // ç«‹å³æ ¹æ“šé€ å¥å®Œæˆåº¦äº®èµ·å¥å­æ˜Ÿæ˜Ÿ
            evaluateSentenceCompletion();
        });
    </script>
</body>
</html>

